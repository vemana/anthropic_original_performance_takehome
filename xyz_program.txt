
register tree_values_ptr = @4
register inp_values_ptr = @6
register[] treevals = @tree_values_ptr
register[] t0 = treevals[0]
register[] t1 = treevals[1]
register[] t2 = treevals[2]
register[] t3 = treevals[3]
register[] t4 = treevals[4]
register[] t5 = treevals[5]
register[] t6 = treevals[6]

# treevals holds level 3 values
tree_values_ptr = tree_values_ptr + 7
treevals = @tree_values_ptr
tree_values_ptr = tree_values_ptr - 7

register[] b0 = treevals[0]
register[] b1 = treevals[1]

end global

# Compiler fills in implicit registers tidx and tidxlen
# Declare if you want to use them
thread register tidxlen

# Work registers
thread register[] v, idx, t, p1, p2

tidxlen = tidxlen + inp_values_ptr
v = @tidxlen


######### Round 0 #########
# p1 = t0
# v = v ^ p1

v = v ^ t0


# Stage 1
v = v * 4097 + 0x7ED55D16

# Stage 2
p1 = v ^ 0xC761C23C
p2 = v >> 19
v = p1 ^ p2

# Fuse stages 3 and 4
p1 = v * 33 + 3925396509
p2 = v * 16896 +2899272192 
v = p1 ^ p2

# Stage 5
v = v * 9 + 0xFD7046C5 

# Stage 6
p1 = v ^ 0xB55A4F09
p2 = v >> 16
v = p1 ^ p2

idx = v % 2

######### Round 1 #########
t = idx ? t2 : t1
v = v ^ t


# Stage 1
v = v * 4097 + 0x7ED55D16

# Stage 2
p1 = v ^ 0xC761C23C
p2 = v >> 19
v = p1 ^ p2

# Fuse stages 3 and 4
p1 = v * 33 + 3925396509
p2 = v * 16896 +2899272192 
v = p1 ^ p2

# Stage 5
v = v * 9 + 0xFD7046C5 

# Stage 6
p1 = v ^ 0xB55A4F09
p2 = v >> 16
v = p1 ^ p2

p1 = v % 2

######### Round 2 #########
p2 = p1 ? t6 : t5
t = p1 ? t4 : t3
t = idx ? p2 : t
idx = idx - -5
idx = idx * 2 + p1
v = v ^ t


# Stage 1
v = v * 4097 + 0x7ED55D16

# Stage 2
p1 = v ^ 0xC761C23C
p2 = v >> 19
v = p1 ^ p2

# Fuse stages 3 and 4
p1 = v * 33 + 3925396509
p2 = v * 16896 +2899272192 
v = p1 ^ p2

# Stage 5
v = v * 9 + 0xFD7046C5 

# Stage 6
p1 = v ^ 0xB55A4F09
p2 = v >> 16
v = p1 ^ p2

p1 = v % 2
p2 = p1 ? -5 : -6
# p2 = p1 - 6
idx = idx * 2 + p2

######### Round 3 #########
iftid range(0, 32)

idx = idx - 16
idx = idx + 2
# idx in [0, 7]

t = treevals[7]
t = idx ? t : b0

# p1 = treevals[1]
idx = idx - 1
t = idx ? t : b1

p2 = treevals[2]
idx = idx - 1
t = idx ? t : p2

p1 = treevals[3]
idx = idx - 1
t = idx ? t : p1

p2 = treevals[4]
idx = idx - 1
t = idx ? t : p2

p1 = treevals[5]
idx = idx - 1
t = idx ? t : p1

p1 = treevals[6]
p2 = idx - 1
t = p2 ? t : p1

v = v ^ t

elsetid

t = @idx[]
v = v ^ t

endiftid
    

# Stage 1
v = v * 4097 + 0x7ED55D16

# Stage 2
p1 = v ^ 0xC761C23C
p2 = v >> 19
v = p1 ^ p2

# Fuse stages 3 and 4
p1 = v * 33 + 3925396509
p2 = v * 16896 +2899272192 
v = p1 ^ p2

# Stage 5
v = v * 9 + 0xFD7046C5 

# Stage 6
p1 = v ^ 0xB55A4F09
p2 = v >> 16
v = p1 ^ p2

iftid range(0, 32)

p1 = v % 2
idx = idx + 16
idx = idx * 2 + p1

elsetid

p1 = v % 2
p2 = p1 ? -5 : -6
# p2 = p1 - 6
idx = idx * 2 + p2

endiftid
    
######### Round 4 #########
t = @idx[]
v = v ^ t


# Stage 1
v = v * 4097 + 0x7ED55D16

# Stage 2
p1 = v ^ 0xC761C23C
p2 = v >> 19
v = p1 ^ p2

# Fuse stages 3 and 4
p1 = v * 33 + 3925396509
p2 = v * 16896 +2899272192 
v = p1 ^ p2

# Stage 5
v = v * 9 + 0xFD7046C5 

# Stage 6
p1 = v ^ 0xB55A4F09
p2 = v >> 16
v = p1 ^ p2

p1 = v % 2
p2 = p1 ? -5 : -6
# p2 = p1 - 6
idx = idx * 2 + p2

######### Round 5 #########
t = @idx[]
v = v ^ t


# Stage 1
v = v * 4097 + 0x7ED55D16

# Stage 2
p1 = v ^ 0xC761C23C
p2 = v >> 19
v = p1 ^ p2

# Fuse stages 3 and 4
p1 = v * 33 + 3925396509
p2 = v * 16896 +2899272192 
v = p1 ^ p2

# Stage 5
v = v * 9 + 0xFD7046C5 

# Stage 6
p1 = v ^ 0xB55A4F09
p2 = v >> 16
v = p1 ^ p2

p1 = v % 2
p2 = p1 ? -5 : -6
# p2 = p1 - 6
idx = idx * 2 + p2

######### Round 6 #########
t = @idx[]
v = v ^ t


# Stage 1
v = v * 4097 + 0x7ED55D16

# Stage 2
p1 = v ^ 0xC761C23C
p2 = v >> 19
v = p1 ^ p2

# Fuse stages 3 and 4
p1 = v * 33 + 3925396509
p2 = v * 16896 +2899272192 
v = p1 ^ p2

# Stage 5
v = v * 9 + 0xFD7046C5 

# Stage 6
p1 = v ^ 0xB55A4F09
p2 = v >> 16
v = p1 ^ p2

p1 = v % 2
p2 = p1 ? -5 : -6
# p2 = p1 - 6
idx = idx * 2 + p2

######### Round 7 #########
t = @idx[]
v = v ^ t


# Stage 1
v = v * 4097 + 0x7ED55D16

# Stage 2
p1 = v ^ 0xC761C23C
p2 = v >> 19
v = p1 ^ p2

# Fuse stages 3 and 4
p1 = v * 33 + 3925396509
p2 = v * 16896 +2899272192 
v = p1 ^ p2

# Stage 5
v = v * 9 + 0xFD7046C5 

# Stage 6
p1 = v ^ 0xB55A4F09
p2 = v >> 16
v = p1 ^ p2

p1 = v % 2
p2 = p1 ? -5 : -6
# p2 = p1 - 6
idx = idx * 2 + p2

######### Round 8 #########
t = @idx[]
v = v ^ t


# Stage 1
v = v * 4097 + 0x7ED55D16

# Stage 2
p1 = v ^ 0xC761C23C
p2 = v >> 19
v = p1 ^ p2

# Fuse stages 3 and 4
p1 = v * 33 + 3925396509
p2 = v * 16896 +2899272192 
v = p1 ^ p2

# Stage 5
v = v * 9 + 0xFD7046C5 

# Stage 6
p1 = v ^ 0xB55A4F09
p2 = v >> 16
v = p1 ^ p2

p1 = v % 2
p2 = p1 ? -5 : -6
# p2 = p1 - 6
idx = idx * 2 + p2

######### Round 9 #########
t = @idx[]
v = v ^ t


# Stage 1
v = v * 4097 + 0x7ED55D16

# Stage 2
p1 = v ^ 0xC761C23C
p2 = v >> 19
v = p1 ^ p2

# Fuse stages 3 and 4
p1 = v * 33 + 3925396509
p2 = v * 16896 +2899272192 
v = p1 ^ p2

# Stage 5
v = v * 9 + 0xFD7046C5 

# Stage 6
p1 = v ^ 0xB55A4F09
p2 = v >> 16
v = p1 ^ p2

p1 = v % 2
p2 = p1 ? -5 : -6
# p2 = p1 - 6
idx = idx * 2 + p2

######### Round 10 #########
t = @idx[]
v = v ^ t


# Stage 1
v = v * 4097 + 0x7ED55D16

# Stage 2
p1 = v ^ 0xC761C23C
p2 = v >> 19
v = p1 ^ p2

# Fuse stages 3 and 4
p1 = v * 33 + 3925396509
p2 = v * 16896 +2899272192 
v = p1 ^ p2

# Stage 5
v = v * 9 + 0xFD7046C5 

# Stage 6
p1 = v ^ 0xB55A4F09
p2 = v >> 16
v = p1 ^ p2

######### Round 11 #########
# p1 = t0
# v = v ^ p1

v = v ^ t0


# Stage 1
v = v * 4097 + 0x7ED55D16

# Stage 2
p1 = v ^ 0xC761C23C
p2 = v >> 19
v = p1 ^ p2

# Fuse stages 3 and 4
p1 = v * 33 + 3925396509
p2 = v * 16896 +2899272192 
v = p1 ^ p2

# Stage 5
v = v * 9 + 0xFD7046C5 

# Stage 6
p1 = v ^ 0xB55A4F09
p2 = v >> 16
v = p1 ^ p2

idx = v % 2

######### Round 12 #########
t = idx ? t2 : t1
v = v ^ t


# Stage 1
v = v * 4097 + 0x7ED55D16

# Stage 2
p1 = v ^ 0xC761C23C
p2 = v >> 19
v = p1 ^ p2

# Fuse stages 3 and 4
p1 = v * 33 + 3925396509
p2 = v * 16896 +2899272192 
v = p1 ^ p2

# Stage 5
v = v * 9 + 0xFD7046C5 

# Stage 6
p1 = v ^ 0xB55A4F09
p2 = v >> 16
v = p1 ^ p2

p1 = v % 2

######### Round 13 #########
p2 = p1 ? t6 : t5
t = p1 ? t4 : t3
t = idx ? p2 : t
idx = idx - -5
idx = idx * 2 + p1
v = v ^ t


# Stage 1
v = v * 4097 + 0x7ED55D16

# Stage 2
p1 = v ^ 0xC761C23C
p2 = v >> 19
v = p1 ^ p2

# Fuse stages 3 and 4
p1 = v * 33 + 3925396509
p2 = v * 16896 +2899272192 
v = p1 ^ p2

# Stage 5
v = v * 9 + 0xFD7046C5 

# Stage 6
p1 = v ^ 0xB55A4F09
p2 = v >> 16
v = p1 ^ p2

p1 = v % 2
p2 = p1 ? -5 : -6
# p2 = p1 - 6
idx = idx * 2 + p2

######### Round 14 #########
iftid range(0, 32)

idx = idx - 16
idx = idx + 2
# idx in [0, 7]

t = treevals[7]
t = idx ? t : b0

# p1 = treevals[1]
idx = idx - 1
t = idx ? t : b1

p2 = treevals[2]
idx = idx - 1
t = idx ? t : p2

p1 = treevals[3]
idx = idx - 1
t = idx ? t : p1

p2 = treevals[4]
idx = idx - 1
t = idx ? t : p2

p1 = treevals[5]
idx = idx - 1
t = idx ? t : p1

p1 = treevals[6]
p2 = idx - 1
t = p2 ? t : p1

v = v ^ t

elsetid

t = @idx[]
v = v ^ t

endiftid
    

# Stage 1
v = v * 4097 + 0x7ED55D16

# Stage 2
p1 = v ^ 0xC761C23C
p2 = v >> 19
v = p1 ^ p2

# Fuse stages 3 and 4
p1 = v * 33 + 3925396509
p2 = v * 16896 +2899272192 
v = p1 ^ p2

# Stage 5
v = v * 9 + 0xFD7046C5 

# Stage 6
p1 = v ^ 0xB55A4F09
p2 = v >> 16
v = p1 ^ p2

iftid range(0, 32)

p1 = v % 2
idx = idx + 16
idx = idx * 2 + p1

elsetid

p1 = v % 2
p2 = p1 ? -5 : -6
# p2 = p1 - 6
idx = idx * 2 + p2

endiftid
    
######### Round 15 #########
t = @idx[]
v = v ^ t


# Stage 1
v = v * 4097 + 0x7ED55D16

# Stage 2
p1 = v ^ 0xC761C23C
p2 = v >> 19
v = p1 ^ p2

# Fuse stages 3 and 4
p1 = v * 33 + 3925396509
p2 = v * 16896 +2899272192 
v = p1 ^ p2

# Stage 5
v = v * 9 + 0xFD7046C5 

# Stage 6
p1 = v ^ 0xB55A4F09
p2 = v >> 16
v = p1 ^ p2

@tidxlen = v
